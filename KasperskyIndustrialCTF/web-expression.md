# Web - Expression

## 문제
문제에서 주어진 홈페이지에 접속하면 달랑 사칙연산 계산기밖에 없다. 입력은 토큰 또는 숫자밖에 입력할 수 없도록 되어있다. 여기서 토큰은 일반 숫자로 연산을 제출하면 얻을 수 있는 값이다. 또한 Share it이라는 링크가 있는데 접속해보면 토큰을 통해 값을 알려주는 페이지다.

## 접근1 (삽질)
일단 아무것도 없으니 하루종일 연산만 죽도록 했다. 문자도 넣어보고, 특수문자도 넣어보고, 버프슈트로 잡아도 별 특징 없고... 그저 연산만 하다가 몇시간이 지났다.

## 접근2
드디어 이성적으로 접근하기 시작했다. 여기서 input에 인젝션이 먹히지 않으므로 토큰에 중점을 두고 살펴봤다. 여러 값을 넣어보며 토큰을 관찰했는데 토큰 마지막에 ```==``` 기호가 나오는 것을 보아 ```=```으로 패딩되는 Base64 인코딩임을 알 수 있었다.

## 접근3
Base64 디코딩을 해보니 내가 입력한 연산 외에 여러 데이터가 존재했다. 예를 들면 다음과 같다.  
```4 + 4```  
``` javascript
O:10:"Expression":3:{
    s:14:"Expressionop";
    s:3:"sum";
    s:18:"Expressionparams";
    a:2:{
        i:0;
        d:4;
        i:1;
        d:4;}
    s:9:"stringify";
    s:5:"4 + 4";
}
```
도통 뭐가 뭔지는 모르겠어서 뚫어져라 몇시간 쳐다보고, 여러가지 값들을 통해 나온 토큰을 해석해보니 답을 얻을 수 있었다.

## 접근4
알게된 규칙은 다음과 같다.  
- 같은 명령 내에 구분은 ```:``` 기호를 통해 한다.
- s 는 string의 약자다. 문자열을 표현하기 위해 명시해야 하며, 포맷은 ```s :{{len(str)}}:{{str}}```이다.그 다음에 string의 길이가 와야한다.
- a 는 array의 약자다. 배열을 표현하기 위해 명시해야 하며, 내부적으로 i와 포맷에 해당하는 약자가 온다.
- i 는 index의 약자다. 배열의 인덱스를 표현하기 위해 사용한다.
- d 는 decimal의 약자다. 10진수 정수를 표현하기 위해 사용한다.

## 접근5
위의 규칙을 이용해 토큰 확인 페이지에서 실험해보니 내가 원하는 값을 이제 토큰으로 만들어 사용할 수 있었다. 이제 장난만 잘 치면 된다! 가장 먼저 연산의 결과는 정수다. 나는 true나 false로 만들어 플래그를 튀어나오게 하고싶었다. 그래서 and연산을 적용시켜보았다. 그러자 페이지는 and 함수가 없다며 php 에러를 뱉어냈다. 오...꿀인데?

## 접근6
```s:3:"sum"``` 이 부분이 함수인 것을 알 수 있었다. 그렇다면 인자는? 아마도 array에 있는 값들일 것으로 추정된다. 함수명과 인자를 내맘대로 골라쓸 수 있으니 공격을 시작했다. ```s:3:"sum"``` 대신 ```s:10:"shell_exec"```로 대체했고, ```a:2:{i:0;d:4;i:1;d:4;}``` 대신 ```s:2:"ls"```로 대체했다. 

## 해결
마침내 shell_exec("ls") 코드를 실행시킬 수 있었고, 플래그를 찾기 위해 서버를 뒤지다보니 최상위 디렉토리에서 플래그를 찾을 수 있었다.